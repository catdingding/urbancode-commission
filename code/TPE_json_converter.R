json_convert<-function(result,target){
    ##block 1:header & tailer
    json_header<-vector(mode="character",length=length(result[[1]]))
    
    for (i in 1:length(result[[1]])){json_header[i]<-header_parse(result[[1]][i])}
    
    if(length(grep("無前段",result[[1]]))==0){
        if(grepl("散會",result[length(result)])){
            tailer<-paste(result[[length(result)]])
            t.vector<-unique(na.omit(as.numeric(unlist(strsplit(tailer, "[^0-9]+")))))
            if(length(t.vector)==0){
                t.hour<-number_convert(gsub(".*(\\(|（)(.*)時.*","\\2",tailer))
                if(grepl("分",tailer)){
                    t.minute<-number_convert(gsub(".*時(.*)分.*","\\1",tailer))
                } else {
                    t.minute<-"00"
                }
            } else {
                t.hour<-t.vector[1]
                t.minute<-t.vector[2]
            }
            e.time<-paste(t.hour,":",t.minute,sep="")
        } else {
            e.time<-"無紀錄"
        }
        json_header[2]<-paste(json_header[2],",\"end_time\":\"",e.time,"\"",sep="")
    }
    
    ind<-c(grep("attend",json_header),(length(json_header)+1))
    
    if(length(ind)>2){
        for (i in 1:(length(ind)-1)){
            attend.type<-gsub("\"(.*)\":.*","\\1",json_header[ind[i]])
            attend.list<-gsub(".*?:\"(.*?)\".*","\\1",json_header[ind[i]:(ind[i+1]-1)])
            attend.list<-lapply(strsplit(attend.list," "),paste,collapse="\",\"",sep="")
            attend.list<-paste("\"",attend.list,"\"",collapse=",",sep="")
            attend.list<-gsub("委員|顧問","",attend.list)
            
            json_header[ind[i]]<-paste("\"",attend.type,"\":[",attend.list,"]",sep="")
            if(ind[i+1]-ind[i]!=1){json_header[(ind[i]+1):(ind[i+1]-1)]<-NA}
        }
    }
    
    json_header<-json_header[!is.na(json_header)]
    
    if(length(grep("attend_unit",json_header))>0){
        if(!grepl("簽到表|無紀錄",json_header[grep("attend_unit",json_header)])){
           a.unit.txt <-json_header[grep("attend_unit",json_header)]
           unit.vector<-strsplit(gsub(".*\\[\"(.*?)\"\\]","\\1",a.unit.txt),"\",\"")[[1]]
           if (length(grep("：",unit.vector))!=0){
               u.mode=1
               unit.ind<-c(grep("：",unit.vector),length(unit.vector)+1)
           } else {
               u.mode=2
               unit.ind<-c(grep("小學$|中學$|國小$|國中$|院$|會$|處$|局$|所$|公司$|大隊$|代表$|銀行$",unit.vector),length(unit.vector)+1)
           }
           
           ulist.vector<-vector(mode="character",length=(length(unit.ind)-1))
           for(i in 1:(length(unit.ind)-1)){
               unit.list<-unit.vector[unit.ind[i]:(unit.ind[i+1]-1)]
               if(length(grep("未派員",unit.list))!=0){
                   if(u.mode==1){ulist.vector[i]<-paste(unit.list,collapse="",sep="")}
                   else if(u.mode==2){ulist.vector[i]<-paste(unit.list[1],"：",paste(unit.list[-1],collapse="",sep=""),sep="")}
               } else {
                   if(u.mode==1){ulist.vector[i]<-paste(unit.list,collapse="、",sep="")}
                   else if(u.mode==2){ulist.vector[i]<-paste(unit.list[1],"：",paste(unit.list[-1],collapse="、",sep=""),sep="")}
               }
               
           }
           ulist.split<-strsplit(ulist.vector,"：")
           
           for(i in 1:length(ulist.split)){
               ulist.split[[i]][[1]]<-paste("\"unit\":\"",ulist.split[[i]][[1]],"\"",sep="")
               if(length(ulist.split[[i]])>1){
                   ulist.split[[i]][[2]]<-paste("\"",strsplit(ulist.split[[i]][[2]],"、")[[1]],"\"",collapse=",",sep="")
                   ulist.split[[i]][[2]]<-paste("\"attendee\":[",ulist.split[[i]][[2]],"]",sep="")
                   ulist.split[[i]]<-paste("{",ulist.split[[i]][[1]],",",ulist.split[[i]][[2]],"}",sep="")
               } else {
                   ulist.split[[i]]<-paste("{",ulist.split[[i]][[1]],"}",sep="")
               }
           }
           
           json_header[grep("attend_unit",json_header)]<-paste("\"attend_unit\":[",paste(unlist(ulist.split),collapse=",",sep=""),"]",sep="")
        }
    }
     
    
    json_header<-paste(json_header,collapse=",")
    
    ##block 2:body
    json_body<-rep(list(NULL),(length(result)-2))
    
    for(m in 2:(length(result)-1)){
        for(i in 1:length(result[[m]])){
            json_body_txt<-paste(body_txt_parse(result[[m]][[i]][[1]]),collapse=",")
            if(length(result[[m]][[i]])==2){
                json_body_table<-paste(body_table_parse(result[[m]][[i]][[2]]),collapse=",")
                json_body[[m-1]][[i]]<-paste("{",paste(c(json_body_txt,json_body_table),collapse=","),"}",sep="")
            } else {
                json_body[[m-1]][[i]]<-paste("{",json_body_txt,"}",sep="")
            }
        }
        
        name.tag<-""
        if(grepl("宣讀",names(result[m]))){
            name.tag<-"confirm_item"
        } else if(grepl("報告事項",names(result[m]))){
            name.tag<-"report_item"
        } else if(grepl("審議事項|討論事項",names(result[m]))){
            name.tag<-"deliberate_item"
        } else if(grepl("研議事項",names(result[m]))){
            name.tag<-"discuss_item"
        } else if(grepl("臨時動議",names(result[m]))){
            name.tag<-"extempore_item"
        } else {
            name.tag<-"other"
        }
    
        json_body[[m-1]]<-paste("\"",name.tag,"\":[",paste(json_body[[m-1]],collapse=","),"]",sep="")
    }
    
    json_body<-paste(json_body,collapse=",")
    
    ##block 3:export json
    json_fulltxt<-paste("{",json_header,",",json_body,"}",sep="")
    
    f.name<-paste("./record/TPEUP/JSON/",target,".json",sep="")
    file.create(f.name)
    
    writeLines(json_fulltxt,con=f.name,useBytes=TRUE)
}

header_parse<-function(header_txt){
    if(Encoding(header_txt)=="UTF-8"){
        if(!is.na(iconv(header_txt,"UTF-8","BIG5"))){
            header_txt<-iconv(header_txt,"UTF-8","BIG5")
        }
    }
    
    if (header_txt=="無前段"){
        header_tag<-c("date","start_time","end_time","location","chairman","note_taker")
        attend_tag<-c("attend_committee","attend_adviser","attend_unit")
        
        title_txt<-paste("\"title\":\"臺北市都市計畫委員會第",target,"次委員會議紀錄\"",sep="")
        session_txt<-paste("\"session\":",target,sep="")
        header_txt<-paste("\"",header_tag,"\":\"無紀錄\"",collapse=",",sep="")
        attend_txt<-paste("\"",attend_tag,"\":[\"無紀錄\"]",collapse=",",sep="")
        
        jsontxt<-paste(title_txt,session_txt,header_txt,attend_txt,sep=",")
        return(jsontxt)
    }
        
    if (grepl("(臺|台)北市都市計(畫|劃)委員會第(.*)次委員(會場)?(會議)+?紀錄",header_txt)){
        session<-number_convert(gsub(".*第( )?(.*)( )?次.*","\\2",header_txt))
        jsontxt<-paste("\"title\":\"",header_txt,"\",\"session\":",session,sep="")
        return(jsontxt)
    }
    else if (grepl("^時(間|問)",header_txt)) {
        m.year<-number_convert(gsub(".*中華民國( )?(.*)( )?年.*","\\2",header_txt))
        m.month<-number_convert(gsub(".*年( )?(.*)( )?月.*","\\2",header_txt))
        m.day<-number_convert(gsub(".*月( )?(.*)( )?日.*","\\2",header_txt))
        m.date<-paste(m.year,"/",m.month,"/",m.day,sep="")
        
        t.hour<-number_convert(gsub(".*午( )?(.*)( )?時.*","\\2",header_txt))
        s.time<-t.hour
        
        if(grepl("分",header_txt)){
            t.minute<-number_convert(gsub(".*時( )?(.*)( )?分.*?","\\2",header_txt))
            s.time<-paste(s.time,":",t.minute,sep="")
        } else {
            s.time<-paste(s.time,":00",sep="")
        }
        
        jsontxt<-paste("\"date\":\"",m.date,"\",\"start_time\":\"",s.time,"\"",sep="")
        return(jsontxt)
    }
    else if (grepl("^地點",header_txt)){
        location<-gsub("^地點(：|:)(.*)$","\\2",header_txt)
        jsontxt<-paste("\"location\":\"",location,"\"",sep="")
        return(jsontxt)
    }
    else if (grepl("^主席",header_txt)){
        chairman<-gsub("^主席(：|:)(.*)$","\\2",header_txt)
        chairman<-gsub("兼主任委員","",chairman)
        jsontxt<-paste("\"chairman\":\"",chairman,"\"",sep="")
        return(jsontxt)
    }
    else if (grepl("^彙整|^紀錄|^記錄",header_txt)){
        note_taker<-gsub("^彙整|^紀錄|^記錄|^記錄彙整(：|:)(.*)$","\\2",header_txt)
        note_taker<-gsub("技士","",note_taker)
        jsontxt<-paste("\"note_taker\":\"",note_taker,"\"",sep="")
        return(jsontxt)
    }
    else if (grepl("^出席委員",header_txt)){
        attend_committee<-gsub("^出席委員(：|:)(.*)$","\\2",header_txt)
        jsontxt<-paste("\"attend_committee\":\"",attend_committee,"\"",sep="")
        return(jsontxt)
    }
    else if (grepl("^出席顧問",header_txt)){
        attend_adviser<-gsub("^出席顧問(：|:)(.*)$","\\2",header_txt)
        jsontxt<-paste("\"attend_adviser\":\"",attend_adviser,"\"",sep="")
        return(jsontxt)
    }
    else if (grepl("^列席單位",header_txt)){
        attend_unit<-gsub("^列席單位(、)?人員(：|:)(.*)$","\\3",header_txt)
        jsontxt<-paste("\"attend_unit\":\"",attend_unit,"\"",sep="")
        return(jsontxt)
    } else {
        jsontxt<-paste("\"",header_txt,"\":\"",header_txt,"\"",sep="")
        return(jsontxt)
    }
}

body_txt_parse<-function(body_txt){
    json.vector<-vector(mode="character",length=length(body_txt))
    
    for(i in 1:length(body_txt)){
        if(is.null(names(body_txt[i]))){
            value<-paste("\"",body_txt[[i]],"\"",sep="",collapse=",")
            json.vector[1]<-paste("\"null\":[",value,"]",sep="")
        } else {
            if(grepl("壹、",names(body_txt[i]))){
                case<-gsub("(NA)?壹、(*)","\\2",body_txt[[i]][[1]])
                json.vector[1]<-paste("\"case\":\"",case,"\"",sep="")
            }
            else if(grepl("事項",names(body_txt[i]))){
                case<-gsub("案名(：|:)(*)","\\2",body_txt[[i]][[1]])
                json.vector[1]<-paste("\"case\":\"",case,"\"",sep="")
            }
            else if(grepl("說明(：|:)",names(body_txt[i]))){
                description<-paste("\"",body_txt[[i]],"\"",sep="",collapse=",")
                json.vector[i]<-paste("\"description\":[",description,"]",sep="")
            }
            else if(grepl("^決議(：|:)",names(body_txt[i]))){
                miss.txt<-gsub(".*(:|：)(.*?)","\\2",names(body_txt[i]))
                resolution<-paste("\"",miss.txt,body_txt[[i]],"\"",sep="",collapse=",")
                json.vector[i]<-paste("\"resolution\":[",resolution,"]",sep="")
            }
            else if(grepl("^附帶決議(：|:)",names(body_txt[i]))){
                miss.txt<-gsub(".*(:|：)(.*?)","\\2",names(body_txt[i]))
                add_resolution<-paste("\"",miss.txt,body_txt[[i]],"\"",sep="",collapse=",")
                json.vector[i]<-paste("\"add_resolution\":[",add_resolution,"]",sep="")
            }
            else {
                other_content<-paste("\"",body_txt[[i]],"\"",sep="",collapse=",")
                json.vector[i]<-paste("\"other_content\":[",other_content,"]",sep="")
            }
        }
    }
    
    return(json.vector)
}

body_table_parse<-function(body_table){
    json.vector<-vector(mode="character",length=length(body_table))
    
    for(i in 1:length(json.vector)){
        table.txt<-paste("\"",gsub("\"","(quote)",unlist(body_table[[i]])),"\"",collapse=",",sep="")
        ##table.txt<-paste("\"",unlist(body_table[[i]]),"\"",collapse=",",sep="")
        json.vector[i]<-paste("[",table.txt,"]",sep="")
    }
    
    tabletxt<-paste(json.vector,collapse=",",sep="")
    jsontxt<-paste("\"petition\":[",tabletxt,"]",sep="")
    
    return(jsontxt)
}

number_convert<-function(number_txt){
    zh_number<-c("一","二","三","四","五","六","七","八","九","十","○")
    ab_number<-c("1","2","3","4","5","6","7","8","9","*10+","0")
    
    number.vector<-unlist(strsplit(number_txt,""))
    if("十" %in% number.vector){n.mode=1} else {n.mode=2}
    for(i in 1:length(number.vector)){
        if(number.vector[i] %in% zh_number){
            number.vector[i]<-ab_number[grep(number.vector[i],zh_number)]
        }
    }
    if(n.mode==1){
        number_paste<-paste(number.vector,collapse="",sep="")
        if(number_txt=="十"){
            number_paste<-"10"
        } else if(grepl("^十",number_txt)){
            number_paste<-paste("1",number_paste,sep="")
        } else if (grepl("十$",number_txt)){
            number_paste<-paste(number_paste,"0",sep="")
        }
        convert.number<-eval(parse(text=number_paste))
    } else {
        convert.number<-as.integer(paste(number.vector,collapse="",sep=""))
    }
    
    return(convert.number)
}